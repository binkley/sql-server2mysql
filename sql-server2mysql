#!/bin/bash

# Uses long options and modern getopt.  Validate this assumption
getopt -T 2>/dev/null
case $? in
4 ) ;; # Good - see getopt(1)
* ) echo "$0: Wrong getopt, sorry" >&2 ; exit 4 ;;
esac

function usage()
{
    echo "usage: $0 [-hv]"
}

function help()
{
    usage
    cat <<EOH
  -h  (help) Print help and exit
  -v  (verbose) Explain processing
EOH
}

verbose=false

args=$(getopt -n "$0" -l help,verbose -o hv -s bash -- "$@") || exit $?
set - $args

while getopts :hv-: opt
do
    case "$opt" in
    h ) help ; exit 0 ;;
    v ) verbose=true ;;
    - ) case $OPTARG in
        help ) help ; exit 0 ;;
        verbose ) verbose=true ;;
        * ) usage >&2 ; exit 2 ;;
        esac ;;
    * ) usage >&2 ; exit 2 ;;
    esac
done
shift $((OPTIND - 1))

while IFS='' read line
do
    # MySQL requires space after -- in comments
    line="${line/--/-- }"
    $verbose && echo "Fixed comments" >&2
    # Always strip square brackets from identifiers
    line="${line//[/}"
    line="${line//]/}"
    $verbose && echo "Fixed brackets" >&2

    echo "$line"
done
